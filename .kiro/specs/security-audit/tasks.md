# 安全审计与加固实施计划

## 任务列表

- [ ] 1. 建立安全基础设施
  - 创建安全模块结构和核心类型定义
  - 建立安全配置管理系统
  - 设置安全测试框架
  - _需求: 1.1-1.7, 18.1-18.7_

- [ ] 1.1 创建安全模块结构
  - 创建 `src-tauri/src/security/` 目录
  - 定义核心安全类型和错误类型
  - 创建 `SecurityConfig` 结构体
  - _需求: 所有需求的基础_

- [ ] 1.2 实施安全配置管理
  - 实现 `SecurityConfig` 的加载和验证
  - 添加配置文件 schema 验证
  - 实现配置热重载机制
  - _需求: 13.1-13.7_

- [ ]* 1.3 建立安全测试框架
  - 添加 `proptest` 依赖用于属性测试
  - 创建测试辅助函数和 fixtures
  - 配置 CI/CD 安全测试流水线
  - _需求: 18.1-18.7_

- [ ] 2. 增强加密和密钥管理（高优先级）
  - 实施 Argon2 增强的密钥派生
  - 添加密码强度验证
  - 实施敏感数据内存清零
  - 修复机器 ID 失败处理
  - _需求: 1.1-1.7_

- [ ] 2.1 实施增强的密钥派生
  - 创建 `EnhancedCryptoManager` 模块
  - 实现 `derive_machine_key_secure()` 使用 Argon2id
  - 配置 Argon2 参数（内存 19MB, 时间 2, 并行 1）
  - 添加性能基准测试
  - _需求: 1.2, 1.4_

- [ ]* 2.2 编写密钥派生属性测试
  - **属性 1: 密钥长度充足性**
  - **验证: 需求 1.1**

- [ ] 2.3 实施密码强度验证
  - 创建 `validate_password_strength()` 函数
  - 实现长度检查（最小 12 字符）
  - 实现复杂度检查（大小写、数字、特殊字符）
  - 添加密码强度评分系统
  - _需求: 1.5_

- [ ]* 2.4 编写密码验证属性测试
  - **属性 3: 密码强度验证**
  - **验证: 需求 1.5**

- [ ] 2.5 实施敏感数据清零
  - 添加 `zeroize` crate 依赖
  - 创建 `SecureMemory<T>` 包装类型
  - 实现 `Drop` trait 自动清零
  - 更新所有敏感数据使用 `SecureMemory`
  - _需求: 1.7, 2.8, 4.3_

- [ ]* 2.6 编写内存清零属性测试
  - **属性 4: 敏感数据清零**
  - **验证: 需求 2.8, 4.3**

- [ ] 2.7 修复机器 ID 失败处理
  - 移除 `get_machine_id()` 中的默认值回退
  - 返回明确的错误而不是使用 "default-*-id"
  - 添加错误处理和用户提示
  - _需求: 1.3_

- [ ]* 2.8 编写机器 ID 失败测试
  - 模拟机器 ID 获取失败场景
  - 验证系统返回错误而不是默认值
  - _需求: 1.3_

- [ ] 3. 强化存储安全（高优先级）
  - 实施跨平台文件权限设置
  - 实施安全删除功能
  - 添加 Nonce 唯一性验证
  - _需求: 2.1-2.8, 6.1-6.7_

- [ ] 3.1 创建安全存储管理器
  - 创建 `SecureStorageManager` 模块
  - 实现 `secure_write()` 跨平台文件写入
  - 实现 `secure_create_dir()` 跨平台目录创建
  - _需求: 2.3, 2.4, 2.5_

- [ ] 3.2 实施 Unix 文件权限设置
  - 在 `secure_write()` 中设置 0600 权限
  - 在 `secure_create_dir()` 中设置 0700 权限
  - 添加权限验证函数 `verify_permissions()`
  - _需求: 2.3, 2.4, 6.1, 6.2_

- [ ]* 3.3 编写 Unix 权限属性测试
  - **属性 5: Unix 文件权限正确性**
  - **属性 6: Unix 目录权限正确性**
  - **验证: 需求 2.3, 2.4**

- [ ] 3.4 实施 Windows ACL 设置
  - 使用 Windows API 设置文件 DACL
  - 限制访问权限为当前用户
  - 添加 Windows 权限验证
  - _需求: 2.5, 6.3_

- [ ]* 3.5 编写 Windows ACL 测试
  - 验证 Windows 文件 ACL 设置正确
  - 验证只有当前用户可以访问
  - _需求: 2.5_

- [ ] 3.6 实施安全删除功能
  - 创建 `secure_delete()` 函数
  - 实现多次覆写（3 次随机数据 + 1 次零）
  - 添加删除验证
  - _需求: 2.7_

- [ ]* 3.7 编写安全删除属性测试
  - **属性 7: 安全删除有效性**
  - **验证: 需求 2.7**

- [ ] 3.8 实施 Nonce 唯一性验证
  - 在 `encrypt_data()` 中添加 Nonce 跟踪
  - 实现 Nonce 碰撞检测
  - 添加 Nonce 生成统计
  - _需求: 2.2_

- [ ]* 3.9 编写 Nonce 唯一性属性测试
  - **属性 2: Nonce 唯一性**
  - **验证: 需求 2.2**

- [ ] 4. 实施输入验证框架（高优先级）
  - 创建统一的输入验证器
  - 实施路径遍历防护
  - 实施邮箱和账户名验证
  - 实施 JSON schema 验证
  - _需求: 5.1-5.7_

- [ ] 4.1 创建输入验证器模块
  - 创建 `InputValidator` 结构体
  - 定义 `ValidationError` 错误类型
  - 实现验证结果类型
  - _需求: 5.1-5.7_

- [ ] 4.2 实施路径验证
  - 实现 `validate_path()` 函数
  - 检测路径遍历模式（../, ..\\）
  - 实施路径规范化
  - 添加路径白名单验证
  - _需求: 5.1_

- [ ]* 4.3 编写路径验证属性测试
  - **属性 8: 路径遍历防护**
  - **验证: 需求 5.1**

- [ ] 4.4 实施邮箱验证
  - 实现 `validate_email()` 函数
  - 使用正则表达式验证邮箱格式
  - 添加邮箱长度限制
  - _需求: 5.3_

- [ ]* 4.5 编写邮箱验证属性测试
  - **属性 9: 邮箱格式验证**
  - **验证: 需求 5.3**

- [ ] 4.6 实施账户名验证
  - 实现 `validate_account_name()` 函数
  - 检查字符集（字母、数字、-_）
  - 添加长度限制（3-64 字符）
  - _需求: 5.2_

- [ ]* 4.7 编写账户名验证属性测试
  - **属性 11: 账户名称字符集限制**
  - **验证: 需求 5.2**

- [ ] 4.8 实施 JSON 验证
  - 添加 `jsonschema` crate 依赖
  - 实现 `validate_json_structure()` 函数
  - 定义备份数据 schema
  - 添加 JSON 深度和大小限制
  - _需求: 5.4, 5.7_

- [ ]* 4.9 编写 JSON 验证属性测试
  - **属性 10: JSON 结构验证**
  - **验证: 需求 5.4**

- [ ] 5. 强化数据库安全（高优先级）
  - 审计所有 SQL 查询
  - 实施安全数据库访问层
  - 添加数据库路径验证
  - 实施备份完整性验证
  - _需求: 3.1-3.7_


- [ ] 5.1 创建安全数据库访问层
  - 创建 `SecureDatabaseAccess` 模块
  - 实现参数化查询包装器
  - 添加查询日志（不含敏感数据）
  - _需求: 3.1, 3.6_

- [ ] 5.2 审计现有 SQL 查询
  - 审查 `account_commands.rs` 中的所有 SQL
  - 审查 `backup.rs` 中的所有 SQL
  - 将字符串拼接改为参数化查询
  - _需求: 3.1_

- [ ]* 5.3 编写 SQL 参数化属性测试
  - **属性 12: SQL 参数化强制**
  - **验证: 需求 3.1**

- [ ] 5.4 实施数据库路径验证
  - 实现 `validate_db_path()` 函数
  - 添加路径白名单检查
  - 防止路径遍历攻击
  - _需求: 3.2_

- [ ]* 5.5 编写数据库路径验证属性测试
  - **属性 13: 数据库路径验证**
  - **验证: 需求 3.2**

- [ ] 5.6 实施备份完整性验证
  - 在备份文件中添加 HMAC 签名
  - 在恢复时验证 HMAC
  - 添加版本兼容性检查
  - _需求: 3.5, 15.1_

- [ ]* 5.7 编写备份完整性属性测试
  - **属性 15: 备份完整性验证**
  - **属性 25: 加密认证性**
  - **验证: 需求 3.5, 15.1**

- [ ] 6. Checkpoint - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 7. 实施日志和审计安全（中优先级）
  - 创建审计日志系统
  - 实施敏感信息过滤
  - 添加日志轮转和权限设置
  - _需求: 7.1-7.7, 4.5_

- [ ] 7.1 创建审计日志管理器
  - 创建 `AuditLogger` 模块
  - 定义 `SecurityEvent` 结构体
  - 实现事件类型和严重级别枚举
  - _需求: 7.2_

- [ ] 7.2 实施敏感信息过滤
  - 创建 `sanitize_log_data()` 函数
  - 定义敏感数据模式（API 密钥、密码、令牌）
  - 实现正则表达式过滤
  - 集成到现有日志系统
  - _需求: 4.5, 7.1_

- [ ]* 7.3 编写日志过滤属性测试
  - **属性 16: 日志敏感信息过滤**
  - **验证: 需求 4.5, 7.1**

- [ ] 7.4 实施安全事件记录
  - 实现 `log_security_event()` 函数
  - 实现 `log_auth_event()` 函数
  - 实现 `log_data_access()` 函数
  - _需求: 7.2, 7.6_

- [ ]* 7.5 编写审计日志属性测试
  - **属性 18: 审计日志完整性**
  - **验证: 需求 7.2**

- [ ] 7.6 实施日志文件安全
  - 设置日志文件权限（0640）
  - 实现日志轮转（按大小和时间）
  - 添加日志文件大小限制
  - _需求: 7.4, 7.5_

- [ ] 8. 强化错误处理（中优先级）
  - 实施安全的错误消息
  - 防止信息泄露
  - 统一错误响应格式
  - _需求: 9.1-9.7_

- [ ] 8.1 创建安全错误类型
  - 定义 `SecurityError` 枚举
  - 实现用户友好的错误消息
  - 分离内部错误和用户错误
  - _需求: 9.1-9.4_

- [ ] 8.2 更新加密错误处理
  - 修改 `CryptoError` 不泄露密钥信息
  - 返回通用错误消息
  - 记录详细错误到安全日志
  - _需求: 9.1_

- [ ] 8.3 更新文件错误处理
  - 修改文件错误不包含完整路径
  - 使用相对路径或文件名
  - 记录完整路径到安全日志
  - _需求: 9.2_

- [ ] 8.4 更新数据库错误处理
  - 修改数据库错误不泄露 SQL 查询
  - 返回通用数据库错误
  - 记录详细错误到安全日志
  - _需求: 9.3_

- [ ]* 8.5 编写错误消息安全属性测试
  - **属性 17: 错误消息安全性**
  - **验证: 需求 9.1-9.4**

- [ ] 9. 强化内存安全（中优先级）
  - 实施缓存过期机制
  - 优化进程内存扫描
  - 添加程序终止清理
  - _需求: 4.1-4.7_

- [ ] 9.1 实施缓存过期机制
  - 更新 `CacheManager` 添加 TTL
  - 实现自动缓存清理
  - 添加缓存统计和监控
  - _需求: 4.4_

- [ ]* 9.2 编写缓存过期属性测试
  - **属性 19: 缓存过期机制**
  - **验证: 需求 4.4**

- [ ] 9.3 优化进程内存扫描
  - 限制内存扫描范围
  - 添加进程身份验证
  - 实现最小权限访问
  - _需求: 4.1, 4.2_

- [ ]* 9.4 编写内存扫描属性测试
  - **属性 20: 进程内存访问最小化**
  - **验证: 需求 4.1**

- [ ] 9.5 实施程序终止清理
  - 注册 shutdown hook
  - 清理所有缓存的敏感数据
  - 清零内存中的密钥
  - _需求: 4.7_

- [ ] 10. Checkpoint - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户


- [ ] 11. 强化网络安全（中优先级）
  - 配置安全的 HTTP 客户端
  - 强化 TLS 设置
  - 实施 CSRF Token 验证
  - _需求: 10.1-10.7_

- [ ] 11.1 创建网络安全管理器
  - 创建 `NetworkSecurityManager` 模块
  - 实现 `create_secure_client()` 函数
  - 配置 TLS 1.2+ 强制
  - _需求: 10.1_

- [ ]* 11.2 编写 TLS 版本属性测试
  - **属性 21: TLS 版本强制**
  - **验证: 需求 10.1**

- [ ] 11.3 实施证书验证
  - 实现 `verify_certificate()` 函数
  - 检查证书有效性和过期时间
  - 验证证书链完整性
  - _需求: 10.2_

- [ ]* 11.4 编写证书验证属性测试
  - **属性 22: 证书验证完整性**
  - **验证: 需求 10.2**

- [ ] 11.5 强化 CSRF Token 处理
  - 实现 `verify_csrf_token()` 函数
  - 添加 Token 格式验证
  - 实施 Token 过期检查
  - _需求: 10.6_

- [ ] 11.6 配置网络超时和重试
  - 设置连接超时（30 秒）
  - 设置读取超时（60 秒）
  - 配置重试策略（最多 3 次）
  - _需求: 10.5_

- [ ] 12. 实施并发安全（中优先级）
  - 实施原子文件操作
  - 添加权限验证原子性
  - 防止竞态条件
  - _需求: 14.1-14.7_

- [ ] 12.1 实施原子文件操作
  - 使用临时文件 + 重命名模式
  - 实现 `atomic_write()` 函数
  - 防止 TOCTOU 攻击
  - _需求: 14.1_

- [ ]* 12.2 编写文件操作原子性属性测试
  - **属性 23: 文件操作原子性**
  - **验证: 需求 14.1**

- [ ] 12.3 实施权限验证原子性
  - 使用锁机制保护权限检查
  - 确保验证和执行的原子性
  - 添加并发测试
  - _需求: 14.2_

- [ ]* 12.4 编写权限验证原子性属性测试
  - **属性 24: 权限验证原子性**
  - **验证: 需求 14.2**

- [ ] 12.5 实施安全的临时文件创建
  - 使用 `tempfile` crate
  - 设置安全的文件权限
  - 确保自动清理
  - _需求: 14.4_

- [ ] 13. 实施数据完整性验证（中优先级）
  - 添加数据格式验证
  - 实施版本兼容性检查
  - 添加数据损坏检测
  - _需求: 15.1-15.7_

- [ ] 13.1 实施数据格式验证
  - 创建 `validate_data_format()` 函数
  - 定义数据版本号
  - 实现向后兼容性检查
  - _需求: 15.2_

- [ ]* 13.2 编写数据格式验证属性测试
  - **属性 26: 数据格式验证**
  - **验证: 需求 15.2**

- [ ] 13.3 实施数据损坏检测
  - 在关键数据中添加校验和
  - 实现损坏检测和报告
  - 添加用户通知机制
  - _需求: 15.5_

- [ ] 14. Checkpoint - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

- [ ] 15. 建立依赖项安全扫描（低优先级）
  - 集成 cargo-audit
  - 配置 CI/CD 安全检查
  - 建立漏洞响应流程
  - _需求: 8.1-8.7_

- [ ] 15.1 集成 cargo-audit
  - 添加 cargo-audit 到开发依赖
  - 创建审计脚本
  - 配置定期扫描
  - _需求: 8.1_

- [ ] 15.2 配置 CI/CD 安全检查
  - 创建 `.github/workflows/security.yml`
  - 添加 cargo-audit 步骤
  - 添加 cargo-clippy 安全检查
  - 添加 npm audit 检查
  - _需求: 8.1, 8.6_

- [ ] 15.3 建立漏洞响应流程
  - 创建 SECURITY.md 文件
  - 定义漏洞报告渠道
  - 定义响应时间 SLA
  - _需求: 8.4_

- [ ] 16. 实施进程安全（低优先级）
  - 强化进程管理
  - 添加进程身份验证
  - 实施安全的命令执行
  - _需求: 12.1-12.7_

- [ ] 16.1 强化进程终止
  - 验证目标进程身份
  - 检查进程所有权
  - 添加审计日志
  - _需求: 12.1_

- [ ] 16.2 实施安全的命令执行
  - 使用 `Command` API 而非 shell
  - 避免命令注入
  - 添加命令白名单
  - _需求: 12.7_

- [ ] 16.3 实施进程路径验证
  - 验证进程可执行文件路径
  - 检查文件签名（如果可用）
  - 防止恶意进程注入
  - _需求: 12.3_

- [ ] 17. 实施配置安全（低优先级）
  - 加密敏感配置
  - 验证配置文件权限
  - 实施配置验证
  - _需求: 13.1-13.7_

- [ ] 17.1 加密敏感配置项
  - 识别敏感配置字段
  - 实现配置加密/解密
  - 更新配置读写逻辑
  - _需求: 13.2_

- [ ] 17.2 验证配置文件权限
  - 在加载配置前检查权限
  - 拒绝权限过宽的配置文件
  - 添加警告日志
  - _需求: 13.1_

- [ ] 17.3 实施配置值验证
  - 定义配置 schema
  - 验证配置值范围
  - 添加默认值和回退
  - _需求: 13.4_

- [ ] 18. 实施隐私保护（低优先级）
  - 最小化数据收集
  - 实施数据删除功能
  - 添加隐私设置
  - _需求: 17.1-17.7_

- [ ] 18.1 审计数据收集
  - 列出所有收集的用户数据
  - 评估每项数据的必要性
  - 移除不必要的数据收集
  - _需求: 17.1_

- [ ] 18.2 实施完整数据删除
  - 创建 `delete_all_user_data()` 函数
  - 确保删除所有备份和配置
  - 使用安全删除方法
  - _需求: 17.5_

- [ ] 18.3 添加隐私设置界面
  - 添加数据收集开关
  - 添加数据导出功能
  - 添加数据删除确认
  - _需求: 17.3, 17.6_

- [ ] 19. 最终安全审查
  - 执行完整的安全测试套件
  - 进行代码安全审查
  - 更新安全文档
  - _需求: 18.1-18.7_

- [ ] 19.1 执行安全测试套件
  - 运行所有属性测试
  - 运行模糊测试
  - 运行静态分析
  - _需求: 18.1-18.3_

- [ ] 19.2 进行代码安全审查
  - 审查所有安全相关代码
  - 检查 unsafe 代码块
  - 验证错误处理
  - _需求: 18.7_

- [ ] 19.3 更新安全文档
  - 更新 README 安全部分
  - 创建安全最佳实践指南
  - 更新 API 文档
  - _需求: 文档要求_

- [ ] 20. Final Checkpoint - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户
