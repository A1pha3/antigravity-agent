name: Documentation Tests

on:
  push:
    branches: [master, dev]
    paths:
      - 'docs/**'
      - 'scripts/test-docs-*.js'
      - 'scripts/check-docs-quality.js'
      - '.github/workflows/docs-test.yml'
  pull_request:
    branches: [master, dev]
    paths:
      - 'docs/**'
      - 'scripts/test-docs-*.js'
      - 'scripts/check-docs-quality.js'
      - '.github/workflows/docs-test.yml'
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8 ç‚¹è¿è¡Œï¼ˆUTC æ—¶é—´ 0 ç‚¹ï¼‰
    - cron: '0 0 * * 1'
  workflow_dispatch:

concurrency:
  group: docs-test-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-docs-existence:
    name: æµ‹è¯•æ–‡æ¡£å­˜åœ¨æ€§
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run document existence tests
        run: npm run test:docs:existence

  test-docs-sections:
    name: æµ‹è¯•æ–‡æ¡£ç« èŠ‚å®Œæ•´æ€§
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run document section tests
        run: npm run test:docs:sections

  test-docs-links:
    name: æµ‹è¯•æ–‡æ¡£é“¾æ¥æœ‰æ•ˆæ€§
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run document link tests
        run: npm run test:docs:links

  test-api-coverage:
    name: æµ‹è¯• API æ–‡æ¡£è¦†ç›–ç‡
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run API coverage tests
        run: npm run test:docs:api

  test-docs-quality:
    name: æµ‹è¯•æ–‡æ¡£è´¨é‡
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run document quality check
        run: npm run check-docs

  lint-markdown:
    name: Markdown æ ¼å¼æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'

      - name: Install markdownlint-cli
        run: npm install -g markdownlint-cli

      - name: Run markdownlint
        run: markdownlint 'docs/**/*.md' 'README.md' --config .markdownlint.json
        continue-on-error: true

  generate-report:
    name: ç”Ÿæˆæ–‡æ¡£è´¨é‡æŠ¥å‘Š
    needs: [test-docs-existence, test-docs-sections, test-docs-links, test-api-coverage, test-docs-quality]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate quality report
        run: npm run check-docs

      - name: Upload quality report
        uses: actions/upload-artifact@v4
        with:
          name: docs-quality-report
          path: docs-quality-report.json
          retention-days: 30

      - name: Comment PR with report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('docs-quality-report.json', 'utf8'));
            
            const body = `## ğŸ“š æ–‡æ¡£è´¨é‡æŠ¥å‘Š
            
            **æ€»ä½“è¯„åˆ†**: ${report.overallScore}/100
            
            ### ğŸ“Š è¯¦ç»†æŒ‡æ ‡
            - æ–‡æ¡£å®Œæ•´æ€§: ${report.completeness.score}/100
            - å†…å®¹è´¨é‡: ${report.contentQuality.score}/100
            - æ ¼å¼è§„èŒƒ: ${report.formatting.score}/100
            - é“¾æ¥æœ‰æ•ˆæ€§: ${report.linkValidity.score}/100
            
            ${report.issues.length > 0 ? `### âš ï¸ å‘ç°çš„é—®é¢˜\n${report.issues.map(i => `- ${i}`).join('\n')}` : '### âœ… æœªå‘ç°é—®é¢˜'}
            
            å®Œæ•´æŠ¥å‘Šå·²ä¸Šä¼ ä¸º artifactã€‚
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
