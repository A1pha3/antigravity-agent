# Bug 报告与修复计划

## 摘要
在对代码库进行详细审计后，发现了以下安全漏洞和逻辑缺陷。本文件记录了这些问题的详细信息及修复结果。

## 发现的 Bug 列表

### 1. 密钥派生强度不足 (Critical)
*   **位置**: `src-tauri/src/utils/crypto.rs` (`derive_machine_key`)
*   **问题**: 使用快速哈希函数 (SHA-256) 进行密钥派生，使得加密密钥极易受到 GPU 加速的暴力破解攻击。
*   **风险**: 攻击者可以在短时间内破解用户的本地加密数据。
*   **状态**: ✅ **已修复**
*   **修复细节**: 
    - 引入了 `Argon2id` 算法（配置：19MB 内存，2 passes）。
    - 实现了 `derive_machine_key_v2`，通过 `AGCRYPT2` 魔数区分新旧版本。
    - 保持了对旧版 `AGCRYPT1` 数据的解密兼容性。

### 2. 机器 ID 获取失败导致密钥可预测 (Critical)
*   **位置**: `src-tauri/src/utils/crypto.rs` (`get_machine_id`)
*   **问题**: 当无法获取系统机器 ID 时，代码回退到硬编码的默认字符串 `"default-*-id"`。
*   **风险**: 如果获取 ID 失败，所有受影响用户的密钥将变得相同且已知，导致加密完全失效。
*   **状态**: ✅ **已修复**
*   **修复细节**: 
    - 修改 `get_machine_id` 返回 `Result`。
    - 移除了所有默认值回退逻辑。
    - 在无法获取机器 ID 时明确报错，阻止不安全的加密操作。

### 3. Windows 平台文件权限缺失 (High)
*   **位置**: `src-tauri/src/utils/crypto.rs` (`secure_write_file`)
*   **问题**: 仅在 Unix 系统上设置了文件权限 (0600)。在 Windows 上，敏感文件以默认权限创建，可能允许其他用户读取。
*   **风险**: 本地攻击者可能读取敏感的备份或配置数据。
*   **状态**: ✅ **已修复**
*   **修复细节**: 
    - 引入 `windows-acl` crate。
    - 在 Windows 平台上使用 ACL 设置严格的文件访问控制（仅限当前用户访问）。

### 4. 敏感数据内存残留 (Medium)
*   **位置**: 全局 (`crypto.rs`)
*   **问题**: 密码和派生密钥在使用后未从内存中清除 (Zeroize)。
*   **风险**: 恶意软件可能通过内存转储 (Memory Dump) 提取残留的密钥数据。
*   **状态**: ✅ **已修复**
*   **修复细节**: 
    - 引入 `zeroize` crate。
    - 使用 `Zeroizing<[u8; 32]>` 包装密钥，确保变量离开作用域时自动清除内存。

### 5. 密码强度验证缺失 (Medium)
*   **位置**: `src-tauri/src/utils/crypto.rs` (`encrypt_with_password`)
*   **问题**: 允许用户使用任意长度和复杂度的密码。
*   **风险**: 用户可能设置极弱的密码 (如 "123456")，导致数据容易被破解。
*   **状态**: ✅ **已修复**
*   **修复细节**: 
    - 实现了 `validate_password_strength` 函数。
    - 强制要求：长度 >= 12，且必须包含数字、大小写字母和特殊字符。

### 6. 备份逻辑中的静默失败 (Low)
*   **位置**: `src-tauri/src/antigravity/backup.rs`
*   **问题**: 解析数据库中的 `TARGET_STORAGE_MARKER` JSON 失败时，会静默跳过而不记录日志。
*   **风险**: 可能导致部分数据未被备份，且难以排查原因。
*   **状态**: ✅ **已修复**
*   **修复细节**: 
    - 添加了 `match` 语句和 `tracing::warn!` 日志，在解析失败时记录警告信息。

### 7. 缺少安全删除功能 (Low)
*   **位置**: `src-tauri/src/antigravity/backup.rs`
*   **问题**: 删除旧的明文备份文件时使用标准 `remove_file`，数据残留在磁盘上。
*   **风险**: 攻击者可能恢复已删除的明文备份。
*   **状态**: ✅ **已修复**
*   **修复细节**: 
    - 实现了 DoD 5220.22-M 标准的安全删除（3次随机覆盖 + 1次零覆盖）。
    - 更新备份流程以使用安全删除清理旧文件。

## 修复进度

- [x] 1. 修复密钥派生 (Argon2id)
- [x] 2. 修复机器 ID 回退问题
- [x] 3. 修复 Windows ACL 权限
- [x] 4. 实施内存清零 (Zeroize)
- [x] 5. 添加密码强度验证
- [x] 6. 添加备份逻辑警告日志
- [x] 7. 实施安全删除
